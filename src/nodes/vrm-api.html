<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script type="text/javascript">

    function checkSelectedAPIType() {
        [
            'users', 'installations', 'widgets', 'dynamic-ess', 'instalations_and_widgets'
        ].map( x => { $('#input-'+x).hide() })
        const selected = $('select#node-input-api_type').val()
        $('#input-'+selected).show()
        if (selected === 'installations' || selected === 'widgets') {
            $('#input-instalations_and_widgets').show()
        }
    }

    function checkSelectedInstallations() {
        [
            'stats', 'gps-download'
        ].map( x => { $('#input-'+x).hide() })
        const selected = $('select#node-input-installations').val()
        if (selected === 'stats') {
            $('#input-stats-dynamic-ess-warning').hide()
            $('#input-stats').show()

            const selectedAttribute = $('select#node-input-attribute').val()
            if (selectedAttribute === 'dynamic_ess') {
                $('#input-stats-dynamic-ess-warning').show()
            }
        }
        if (selected === 'gps-download' ) { $('#input-gps-download').show()}
        if (selected === 'fetch-dynamic-ess-schedules' ) { $('#input-fetch-dynamic-ess-schedules').show() }
    }

    function checkSelectedUsers() {
        [
            'users-idUser'
        ].map( x => { $('#input-'+x).hide() })
        const selected = $('select#node-input-users').val()
        if (selected !== 'me') { $('#input-users-idUser').show() }
    }

    RED.nodes.registerType('vrm-api', {
        category: 'Victron Energy',
        paletteLabel: 'VRM API',
        color: '#f7ab3e',
        defaults: {
            vrm: {value: "", type: "config-vrm-api", required: false},
            name: { value: "" },
            api_type: { value: "", validate: RED.validators.regex(/^(users|installations|widgets|dynamic-ess)$/)},

            // users
            idUser: { value: "", validate: RED.validators.regex(/^(|[0-9]{1,12})$/)},
            users: { value: "", required: false},

            // installations
            idSite: { value: "", validate: RED.validators.regex(/^(|[0-9]{1,12}|\{\{(node|flow|global)\..*\}\}|)$/)},
            installations: { value: "", required: false},
            attribute: {value: "", required: false},
            stats_interval: {value: ""},
            show_instance: {value: false},
            stats_start: {value: ""},
            stats_end: {value: ""},
            use_utc: { value: false },

            gps_start: {value: '', required: false },
            gps_end: {value: '', required: false },

            stats_interval: {value: ""},

            // widgets
            // taking idSite from installations
            widgets: { value: "", required: false},
            instance: {value: "", required: false},

            store_in_global_context: {value: false},
            verbose: { value: false }
        },
        inputs: 1,
        outputs: 1,
        icon: "victronenergy.svg",
        label: function () {
            if (this.name) {
                return this.name
            }

            var label =  this.api_type

            switch (this.api_type) {
                case 'users': {
                    label += ' - ' + this.users
                }
                break;
                case 'installations': {
                    if ( this.installations === 'stats' ) {
                        label += ' - Stats: ' + this.attribute
                    } else {
                        label += ' - ' + this.installations
                    }
                }
                break;
                case 'widgets': {
                    label += ' - ' + this.widgets
                }
            }

            return label;
        },
        oneditprepare: function oneditprepare() {
            checkSelectedAPIType()

            const $dynamicEssOption = $('#node-input-attribute option[value="dynamic_ess"]')
            const currentAttribute = this.attribute
            if (currentAttribute !== 'dynamic_ess') {
                $dynamicEssOption.remove()
            }

            flatpickr("#node-input-gps_start", {
                enableTime: true,
                dateFormat: "Y-m-d H:i"
            })
            flatpickr("#node-input-gps_end", {
                enableTime: true,
                dateFormat: "Y-m-d H:i"
            })
        }
    });
</script>

<script type="text/html" data-template-name="vrm-api">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-vrm"><i class="fa fa-tag"></i> VRM</label>
        <input type="text" id="node-input-vrm" placeholder="VRM">
    </div>
    <div class="form-row">
        <label for="node-input-api_type"><i class="fa fa-location-arrow"></i> API type</label>
        <select id="node-input-api_type" required onchange="checkSelectedAPIType()">
            <option value="users">Users</option>
            <option value="installations">Installations</option>
            <option value="widgets">Widgets</option>
        </select>
    </div>
    <div id="input-users">
        <div class="form-row">
            <label for="node-input-users"><i class="fa fa-location-arrow"></i> Users</label>
            <select id="node-input-users" onchange="checkSelectedUsers()">
                <option value="installations">All installations/sites</option>
                <option value="me">Basic user information</option>
            </select>
        </div>
        <div id="input-users-idUser">
            <div class="form-row">
                <label for="node-input-idUser"><i class="fa fa-id-card"></i> User id</label>
                <input type="text" id="node-input-idUser" placeholder="User id">
            </div>
        </div>
    </div>
    <div id="input-instalations_and_widgets">
        <div class="form-row">
            <label for="node-input-idSite"><i class="fa fa-id-card"></i> VRM site id</label>
            <input type="text" id="node-input-idSite" placeholder="VRM site id">
        </div>
    </div>
    <div id="input-installations">
        <div class="form-row">
            <label for="node-input-installations"><i class="fa fa-location-arrow"></i> Installation</label>
            <select id="node-input-installations" onchange="checkSelectedInstallations()">
                <option value="alarms">Get Alarms</option>
                <option value="post-alarms">Add Alarm</option>
                <option value="gps-download">GPS tracks</option>
                <option value="system-overview">Connected devices for a given installation</option>
                <option value="diagnostics">Diagnostic data for an installation</option>
                <option value="tags">Get installation tags</option>
                <option value="stats">Installation stats</option>
                <option value="dynamic-ess-settings">Get Dynamic ESS configuration</option>
                <option value="patch-dynamic-ess-settings">Modify Dynamic ESS configuration</option>
                <option value="fetch-dynamic-ess-schedules">Fetch Dynamic ESS schedules</option>
            </select>
        </div>
        <div id="input-fetch-dynamic-ess-schedules" style="display:none;">
            <div class="form-row">
                <p style="margin-left: 102px; color: #666; font-style: italic;">
                    The API always returns buckets of 15 minute intervals. If you have hourly prices configured for your site, the buckets will contain the same price for 4 records in a row.
                The records returned will contain data from the beginning of today until the end of tomorrow (if the prices are in, else until the end of today).
                            </p>
            </div>
        </div>
        <div id="input-stats">
            <div class="form-row">
                <label for="node-input-attribute"><i class="fa fa-location-pencil" ></i> Attribute</label>
                <select id="node-input-attribute" onchange="checkSelectedInstallations()">
                    <option value="Bc">Battery direct use</option>
                    <option value="Bg">Battery to grid</option>
                    <option value="bs">Battery SoC</option>
                    <option value="Gc">Grid direct use</option>
                    <option value="Gb">Grid to battery</option>
                    <option value="Pc">Solar direct use</option>
                    <option value="Pb">Solar to battery</option>
                    <option value="kwh">Total kWh</option>
                    <option value="consumption">Consumption</option>
                    <option value="evcs">EV consumption</option>
                    <option value="vrm_consumption_fc">Consumption Forecast</option>
                    <option value="vrm_pv_inverter_yield_fc">PV Inverter Yield Forecast</option>
                    <option value="vrm_pv_charger_yield_fc">PV Solar Charger Yield Forecast</option>
                    <option value="vrm_solar_irradiance">Solar Irradiance</option>
                    <option value="vrm_solar_irradiance_fc">Solar Irradiance Forecast</option>
                    <option value="solar_yield">Solar Yield</option>
                    <option value="total_solar_yield">Total Solar Yield</option>
                    <option value="solar_yield_forecast">Solar Yield Forecast</option>
                    <option value="dynamic_ess" style="color: #999; font-style: italic;">Dynamic ESS (deprecated)</option>
                </select>
            </div>    
            <div class="form-row">
                <label for="node-input-stats_interval"><i class="fa fa-barcode"></i> Interval</label>
                <select id="node-input-stats_interval">
                    <option value="15mins">15 minutes</option>
                    <option selected="selected" value="hours">hours</option>
                    <option value="2hours">2 hours</option>
                    <option value="days">days</option>
                    <option value="weeks">weeks</option>
                    <option value="months">months</option>
                    <option value="years">years</option>
                </select>
            </div>
            <div class="form-row">
                <label for="node-input-stats_start"><i class="fa fa-calendar"></i> Start</label>
                <select id="node-input-stats_start">
                    <option value="-31536000">-1 year</option>
                    <option value="-7257600">-12 weeks</option>
                    <option value="-2419200">-4 weeks</option>
                    <option value="-604800">-1 week</option>
                    <option value="-259200">-72 hours</option>
                    <option value="-172800">-48 hours</option>
                    <option value="-86400">-24 hours</option>
                    <option value="boy">beginning of yesterday</option>
                    <option value="bod">beginning of day</option>
                    <option value="bot">beginning of tomorrow</option>
                    <option selected="selected" value="0">now</option>
                </select>
            </div>
            <div class="form-row">
                <label for="node-input-stats_end"><i class="fa fa-calendar"></i> End</label>
                <select id="node-input-stats_end">
                    <option value="0">now</option>
                    <option value="eod">end of day</option>
                    <option value="eoy">end of yesterday</option>
                    <option value="eot">end of tomorrow</option>
                    <option value="eoyr">end of year</option>
                    <option selected="selected" value="86400">+24 hours</option>
    ### tfx add more interval options
                    <option selected="selected" value="172800">+48 hours</option>
                    <option selected="selected" value="259200">+72 hours</option>
                    <option selected="selected" value="604800">+1 week</option>
    ### /tfx
                </select>
            </div>
            <div class="form-row" style="margin-bottom:0px;">
                <input type="checkbox" id="node-input-use_utc" style="display:inline-block; margin-left:8px; width:auto; vertical-align:top;">
                <label style="min-width:390px" for="node-input-use_utc"><i class="fa fa-power"></i> Use universal time (UTC) instead of the local time?</label>
            </div>
            <div class="form-row" style="margin-bottom:0px;">
                <input type="checkbox" id="node-input-show_instance" style="display:inline-block; margin-left:8px; width:auto; vertical-align:top;">
                <label style="min-width:390px" for="node-input-show_instance"><i class="fa fa-power"></i> Group attributes by instance?</label>
            </div>
        </div>    
    </div>
    <div id="input-stats-dynamic-ess-warning" style="display:none;">
        <div class="form-row">
            <div style="margin-left: 12px; padding: 12px; background-color: #fff3cd; border-left: 4px solid #ff9800; border-radius: 4px;">
                <p style="margin: 0 0 8px 0; color: #856404; font-weight: bold;">
                    ⚠️ Deprecated Method
                </p>
                <p style="margin: 0 0 8px 0; color: #856404;">
                    Fetching Dynamic ESS schedules via <strong>Installation stats</strong> with <strong>Dynamic ESS</strong> attribute is deprecated.
                </p>
                <p style="margin: 0 0 8px 0; color: #856404;">
                    Please migrate to: <strong>Installations → Fetch Dynamic ESS schedules</strong>
                </p>
                <p style="margin: 0; color: #856404; font-size: 0.9em; font-style: italic;">
                    The new method will be maintained and is the recommended approach going forward.
                </p>
            </div>
        </div>
    </div>
    <div id="input-gps-download">
        <div class="form-row">
            <label for="node-input-gps_start"><i class="fa fa-calendar"></i> Timestamp from which to fetch data</label>
            <input type="text" id="node-input-gps_start" placeholder="Unix timestamp">
        </div>
        <div class="form-row">
            <label for="node-input-gps_end"><i class="fa fa-calendar"></i> Timestamp tp which to fetch data</label>
            <input type="text" id="node-input-gps_end" placeholder="Unix timestamp">
        </div>
    </div>
    <div id="input-widgets">
        <div class="form-row">
            <label for="node-input-widgets"><i class="fa fa-location-arrow"></i> Widgets</label>
            <select id="node-input-widgets">
                <option value="BatterySummary">Battery summary data</option>
                <option value="BMSDiagnostics">BMS diagnostics summary data</option>
                <option value="HistoricData">Historic summary data</option>
                <option value="IOExtenderInOut">IO extender input and output summary data</option>
                <option value="LithiumBMS">Lithium BMS summary data</option>
                <option value="DCMeter">DC meter summary data</option>
                <option value="EvChargerSummary">EV charger summary data</option>
                <option value="MeteorologicalSensor">Meteorological summary data</option>
                <option value="GlobalLinkSummary">GlobalLink summary data</option>
                <option value="MotorSummary">Motor summary data</option>
                <option value="PVInverterStatus">PV inverter summary data</option>
                <option value="SolarChargerSummary">Solar charger summary data</option>
                <option value="Status">System overview summary data</option>
                <option value="TankSummary">Tank summary data</option>
                <option value="TempSummaryAndGraph">Temperature summary data</option>
            </select>
        </div>
        <div class="form-row">
            <label for="node-input-instance"><i class="fa fa-id-card"></i> Instance</label>
            <input type="text" id="node-input-instance" placeholder="Instance for which to retrieve data, defaults to 0">
        </div>
    </div>
    <div class="form-row" style="margin-bottom:0px;">
        <input type="checkbox" id="node-input-store_in_global_context" style="display:inline-block; margin-left:8px; width:auto; vertical-align:top;">
        <label style="min-width:390px" for="node-input-store_in_global_context"> Store the response in the global context?</label>
    </div>
    <div class="form-row" style="margin-bottom:0px;">
        <input type="checkbox" id="node-input-verbose" style="display:inline-block; margin-left:8px; width:auto; vertical-align:top;">
        <label style="min-width:390px" for="node-input-verbose"> Verbose: show the used <em>url</em> in the debug tab?</label>
    </div>
</script>

<script type="text/markdown" data-help-name="vrm-api">
Interface with the Victron Energy VRM API.

### Inputs

: payload (string|number|json) :  the trigger to query the VRM API

### Outputs

: payload (json) : the vrm answer

The output of the answer depends on the selected configuration. See the [VRM API documentation](https://vrm-api-docs.victronenergy.com/#)
in case you need assistance with interpreting the output.

Note that the site id is the multi-digit number you see in the url of your vrm-site. If you need the user id, query
the _basic user information_ first.

### Configuration

: Name (string) : The name of the node
: VRM (config) : The configuration node
: VRM site id (number) : The site to query
: API type (string) : The query type
: Store (boolean) : Store the respones in the global context?
: Verbose (boolean) : Show the used _url_ in the debug tab?

There are currently 3 API types to choose from:
- Users
- Installations
- Widgets

Depending on the API type, more or less extra fields appear.

In case of installation `stats` there appear some extra configuration options  
: Attribute (string) : Which attribute to fetch
: Interval (string) : Time between retrieved data points
: Show instance (boolean) : If checked, attributes will be grouped by instance
: Start (integer) : Timestamp from which to fetch data
: End (integer) : Timestamp to which to fetch data
: UTC (boolean) : Use universal time (UTC) instead of the local time?
: Group by instance (boolean): Group attributes by instance?

In case of installation `dess` there are even more configuration options.

Note that instead of filling out the number of the VRM site id for installations and widgets in the box, you
can also use context variables, e.g. `{{flow.siteId}}` or `{{global.vrmId}}`. This allows to query the site
that has been set in this context field. Of course you need to make sure that context contains a valid VRM site id first.

There is a comparable trick if you want the VRM API credentials to be picked up via another node. If you put the credentials
into the flow context `vrm_api.credentials.token` and set the VRM configuration node to "none", the VRM API node will use the
credentials from the flow context instead.

### Details

This node makes it easy to use the VRM API for data retrieval. Though not all possible API calls have been implemented, it can
be used for retrieving and creating alarms and fetching installations statistics. It can also be used to retrieve the solar forecast
data.

In order to allow the node to query your site, an [access-token](https://vrm.victronenergy.com/access-tokens) needs to be created and filled
out in the configuration node.

If the data is to be stored in the global context, it will be saved under `vrm_api.${site_id}_${installation}`.

### Advanced usage

If you have really spefic needs to query the VRM API, which aren't part of the node (yet), you can input a
payload that contains `msg.query`, `msg.method` and `msg.url`. The node will then use these values to query
the VRM API.  You can also overrule the `msg.topic` for these queries. Note that you _must_ set the `msg.method`
when using this feature.

The `msg.url` part is _everything_ after the `https://vrmapi.victronenergy.com/v2/` part.

### References

Please use either the issues on the GitHub site or the Node-RED space on our community for questions, troubleshooting and suggestions.
- [GitHub](https://github.com/dirkjanfaber/victron-vrm-api) - The nodes GitHub repository.
- [Community](https://community.victronenergy.com/tag/node-red) - Node-RED space in the Victron Energy community.
- [VRM API documentation](https://vrm-api-docs.victronenergy.com/#) - The VRM API documentation.

</script>

